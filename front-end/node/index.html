<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      什么是 koa？ | Forest
    </title>
    <meta name="description" content="笔记记录、阅读">
    <link rel="stylesheet" href="/assets/style.3d4e16a3.css">
    <link rel="modulepreload" href="/assets/Home.dce0e87a.js">
    <link rel="modulepreload" href="/assets/app.e8bd60e9.js">
    <link rel="modulepreload" href="/assets/front-end_node_index.md.f849c135.lean.js">
    <link rel="modulepreload" href="/assets/app.e8bd60e9.js">
    
    
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-5df6160f><div class="sidebar-button" data-v-5df6160f><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Forest, back to home" data-v-5df6160f data-v-8dbfef3c><!----> Forest</a><div class="flex-grow" data-v-5df6160f></div><div class="nav" data-v-5df6160f><nav class="nav-links" data-v-5df6160f data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/" data-v-45eb32c6>首页 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-dropdown-link" data-v-38e3b123 data-v-6bbf01f6><button class="button" data-v-6bbf01f6><span class="button-text" data-v-6bbf01f6>基础</span><span class="right button-arrow" data-v-6bbf01f6></span></button><ul class="dialog" data-v-6bbf01f6><!--[--><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/js/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>javascript</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/vue/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>vue</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/react/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>react</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/babel/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>babel</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/webpack/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>webpack</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/wechat/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>微信小程序</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item active" href="/front-end/node/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>node</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-38e3b123><div class="nav-dropdown-link" data-v-38e3b123 data-v-6bbf01f6><button class="button" data-v-6bbf01f6><span class="button-text" data-v-6bbf01f6>数据库</span><span class="right button-arrow" data-v-6bbf01f6></span></button><ul class="dialog" data-v-6bbf01f6><!--[--><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/database/mongoDB/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>mongoDB</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/database/redis/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>redis</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/database/mysql/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>mysql</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/project/" data-v-45eb32c6>项目 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/go/" data-v-45eb32c6>Go <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/interview/" data-v-45eb32c6>面试 <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-58e261f2><nav class="nav-links nav" data-v-58e261f2 data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/" data-v-45eb32c6>首页 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-dropdown-link" data-v-38e3b123 data-v-6bbf01f6><button class="button" data-v-6bbf01f6><span class="button-text" data-v-6bbf01f6>基础</span><span class="right button-arrow" data-v-6bbf01f6></span></button><ul class="dialog" data-v-6bbf01f6><!--[--><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/js/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>javascript</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/vue/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>vue</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/react/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>react</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/babel/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>babel</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/webpack/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>webpack</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/front-end/wechat/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>微信小程序</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item active" href="/front-end/node/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>node</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-38e3b123><div class="nav-dropdown-link" data-v-38e3b123 data-v-6bbf01f6><button class="button" data-v-6bbf01f6><span class="button-text" data-v-6bbf01f6>数据库</span><span class="right button-arrow" data-v-6bbf01f6></span></button><ul class="dialog" data-v-6bbf01f6><!--[--><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/database/mongoDB/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>mongoDB</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/database/redis/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>redis</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-6bbf01f6><div class="nav-dropdown-link-item" data-v-6bbf01f6 data-v-d552fd76><a class="item" href="/database/mysql/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>mysql</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/project/" data-v-45eb32c6>项目 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/go/" data-v-45eb32c6>Go <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/interview/" data-v-45eb32c6>面试 <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-58e261f2><!--[--><li class="sidebar-link"><a class="sidebar-link-item active" href="/front-end/node/">koa基础</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#什么是-koa？">什么是 koa？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#核心概念">核心概念</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#初识-koa">初识 koa</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#路由基础用法-中间件注册">路由基础用法&amp;中间件注册</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#安装依赖：-koa-router">安装依赖：@koa/router</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#定义路由">定义路由</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#koa-工作原理">koa 工作原理</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#koa-构建-restful-接口及获取参数">koa 构建 restful 接口及获取参数</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-d36a7fda><div class="container" data-v-d36a7fda><!--[--><!--]--><div class="content" data-v-d36a7fda><div data-v-d36a7fda><h2 id="什么是-koa？"><a class="header-anchor" href="#什么是-koa？" aria-hidden="true">#</a> 什么是 koa？</h2><p>koa 是基于 Node.js 平台的下一代 web 开发框架，致力于成为应用和 API 开发领域中的一个更小、更富有表现力、更健壮的基石；利用<em>async 函数</em>丢弃回调函数，并增强错误处理，koa 没有任何预置的中间件，可快速的编写服务端应用程序。</p><h2 id="核心概念"><a class="header-anchor" href="#核心概念" aria-hidden="true">#</a> 核心概念</h2><ul><li>Koa Application（应用程序）</li><li>Context（上下文）</li><li>Request（请求）、Response(响应)</li></ul><h2 id="初识-koa"><a class="header-anchor" href="#初识-koa" aria-hidden="true">#</a> 初识 koa</h2><div class="language-git"><pre><code>$ mkdir acquaintance
$ cd acquaintance
$ npm init -y
$ npm i koa
</code></pre></div><blockquote><p>上面三条命令是：</p><ul><li>创建一个 acquaintance 的文件夹</li><li>进入创建的文件夹</li><li>初始化 package.json</li><li>安装 koa，安装完之后可以在 package.json 中查看安装的所有依赖</li></ul></blockquote><p>在工程目录里创建一个 app.js，代码如下：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 引入koa</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 实例化koa</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hi koa&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 启动应用程序  参数：端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3003</span><span class="token punctuation">)</span>
</code></pre></div><p>在终端中使用<code>node app.js</code>命令（前提是终端中的路径必须指向所创建工程文件夹的路径） 打开浏览器访问：<code>http://localhost:3003</code> 此时浏览器中就会输出<code>hi koa</code>，如下图：</p><!-- ![img](./1.png) --><img src="/assets/1.f566a842.png" style="display:block;box-shadow:2px 1px 1px #d0c6c629;"><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>上面代码虽然轻松实现了一个 web 服务器，但是返回的数据和所请求都是固定的；并不适应真实的业务场景，比如：获取请求接口时的参数、方法、修改一次代码就要在终端中重新运行启动命令等；</p></div><p>由于使用的<code>node app.js</code>启动，所以每次更改都要重新启动，这样给我们开发带来了极大的不便利，所以我们可以使用一些第三方依赖来自动监听文件的变化并重新启动，开发环境可以使用<code>nodemon</code> 首先安装<code>npm i nodemon -D</code>，也可以全局安装此依赖，生产环境的话可以使用<code>pm2</code> 安装之后在<code>package.json</code>的<code>scripts</code>中添加启动方式；如下</p><div class="language-json"><pre><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;acquaintance&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon app.js&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.13.1&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.7&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在终端中执行命令：<code>npm run dev</code>,这样就不用我们每次修改都重新启动，执行之后就会在终端中提示，如下： <img src="/assets/e59f418482657d4dd68a3543880292b.4dac7c38.png" alt=""></p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>执行命令时，终端的路径必须指向当前程序</p></div><h2 id="路由基础用法-中间件注册"><a class="header-anchor" href="#路由基础用法-中间件注册" aria-hidden="true">#</a> 路由基础用法&amp;中间件注册</h2><h3 id="安装依赖：-koa-router"><a class="header-anchor" href="#安装依赖：-koa-router" aria-hidden="true">#</a> 安装依赖：<a href="https://www.npmjs.com/package/@koa/router" target="_blank" rel="noopener noreferrer">@koa/router</a></h3><div class="language-git"><pre><code>$ npm i @koa/router
</code></pre></div><h3 id="定义路由"><a class="header-anchor" href="#定义路由" aria-hidden="true">#</a> 定义路由</h3><ul><li>在 app.js 中引入<code>@koa/router</code>，然后再实例化</li></ul><div class="language-javascript"><pre><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@koa/router&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token string">&#39;/api/v1&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 实例化的时候可以自定义一个接口前缀</span>
</code></pre></div><ul><li>注册 router</li></ul><div class="language-javascript"><pre><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>定义接口</li></ul><div class="language-javascript"><pre><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;hi @koa/router&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;success&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            nickname<span class="token operator">:</span> <span class="token string">&#39;Forest&#39;</span><span class="token punctuation">,</span>
            age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
            jobs<span class="token operator">:</span> <span class="token string">&#39;前端攻城狮&#39;</span><span class="token punctuation">,</span>
            skills<span class="token operator">:</span> <span class="token string">&#39;搬砖&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>完整代码如下：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@koa/router&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token string">&#39;/api/v1&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;hi @koa/router&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;success&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            nickname<span class="token operator">:</span> <span class="token string">&#39;Forest&#39;</span><span class="token punctuation">,</span>
            age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
            jobs<span class="token operator">:</span> <span class="token string">&#39;前端攻城狮&#39;</span><span class="token punctuation">,</span>
            skills<span class="token operator">:</span> <span class="token string">&#39;搬砖&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 启动应用程序  参数：端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3003</span><span class="token punctuation">)</span>
</code></pre></div><p>在浏览器中请求：<code>http://localhost:3003/api/v1</code>、<code>http://localhost:3003/api/v1/user</code>，结果如下图：<br><img src="/assets/218479d47f383ef974d2fda8adceb32.dbbad8f5.png" style="box-shadow:2px 1px 1px #d0c6c629;vertical-align:top;"><img src="/assets/2b6d9070e5014f6bfd01b61adec5d93.5d789ec2.png" style="box-shadow:2px 1px 1px #d0c6c629;vertical-align:top;"></p><h2 id="koa-工作原理"><a class="header-anchor" href="#koa-工作原理" aria-hidden="true">#</a> koa 工作原理</h2><p>Koa 通过 use 方法注册和串联中间件，也就是洋葱模型；所谓洋葱模型，就是指每一个 Koa 中间件都是一层洋葱圈，它即可以掌管请求进入，也可以掌管响应返回。换句话说：外层的中间件可以影响内层的请求和响应阶段，内层的中间件只能影响外层的响应阶段。 <img src="/assets/85988383413dec71e0d17d991ac8a5a.d2b71f1c.png" style="display:block;box-shadow:2px 1px 1px #d0c6c629;"> 执行顺序：按照 app.use()的顺序执行，中间件可以通过 await next()来执行下一个中间件，同时在最后一个中间件执行完成后，依然有恢复执行的能力。即，通过洋葱模型，await next()控制调用 “下游”中间件，直到 “下游”没有中间件且堆栈执行完毕，最终流回“上游”中间件。这种方式有个优点，特别是对于日志记录以及错误处理等需要非常友好。</p><p>下面这段代码的结果就能很好的诠释，示例：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a middleware 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a middleware 1 end </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a middleware 2</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a middleware 2 end </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a middleware 3</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a middleware 3 end </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3004</span><span class="token punctuation">)</span>
</code></pre></div><p>运行结果：</p><div class="language-base"><pre><code>this is a middleware 1
this is a middleware 2
this is a middleware 3
this is a middleware 3 end
this is a middleware 2 end
this is a middleware 1 end
</code></pre></div><h2 id="koa-构建-restful-接口及获取参数"><a class="header-anchor" href="#koa-构建-restful-接口及获取参数" aria-hidden="true">#</a> koa 构建 restful 接口及获取参数</h2><ul><li>在 params 中取值，<code>eg：http://localhost:3003/api/v1/user/1</code></li></ul><div class="language-javascript"><pre><code><span class="token comment">//请求时若为：http://localhost:3003/api/v1/user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id&#39;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取url的id</span>
  cosnt <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span><span class="token comment">//{id: 1}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>在 query 中取值，也就是获取问号后面的。</li></ul><div class="language-javascript"><pre><code><span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;http://localhost:3003/api/v1/user?name=Forest&amp;age=18&#39;</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取url的id</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query <span class="token comment">//{name: Forest, age: 18}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>获取 header 中的参数：</li></ul><div class="language-javascript"><pre><code><span class="token comment">//请求接口时设置请求头</span>
axios
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
        <span class="token string">&#39;http://localhost/user?name=Forest&amp;age=18&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                Author<span class="token operator">:</span> <span class="token string">&#39;token&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//......</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;res:&#39;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//在服务端获取则是：</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取 url 的 id</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> Author <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header <span class="token comment">//{Author: token}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>获取 body 中的数据，在服务端获取 body 中的一些数据只能用一些外部的插件；如：<code>koa-body</code>、<code>koa-bodyparser</code> 等等。 就以 <code>koa-body</code> 为例，首先安装 <code>npm i koa-body -S</code>，再引入：</li></ul><div class="language-javascript"><pre><code><span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>&#39;koa<span class="token operator">-</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//然后在注册中间件：</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在服务端获取则是：</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><span class="token comment">//{name: &#39;Foreset&#39;, age: 18}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//请求时有两种传参方式，一种是 json，另一种是 fromData；以 json 为例</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;http://localhost/user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">&#39;Foreset&#39;</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;res:&#39;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>restful 接口完整代码：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@koa/router&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> koaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-body&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token string">&#39;/api/v1&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;hi @koa/router&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// const { name, age } = ctx.query</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;success&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            query<span class="token operator">:</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
            nickname<span class="token operator">:</span> <span class="token string">&#39;Forest&#39;</span><span class="token punctuation">,</span>
            age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
            jobs<span class="token operator">:</span> <span class="token string">&#39;前端攻城狮&#39;</span><span class="token punctuation">,</span>
            skills<span class="token operator">:</span> <span class="token string">&#39;搬砖&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;id:&#39;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;success&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">,</span>
            nickname<span class="token operator">:</span> <span class="token string">&#39;Forest&#39;</span><span class="token punctuation">,</span>
            age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
            jobs<span class="token operator">:</span> <span class="token string">&#39;前端攻城狮&#39;</span><span class="token punctuation">,</span>
            skills<span class="token operator">:</span> <span class="token string">&#39;搬砖&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">,</span>
            age
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>allowedMethods<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3003</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意 koa-body 中间件的引入顺序必须在 router 之前，否则获取不了 post 请求携带的数据</p></div></div></div><footer class="page-footer" data-v-d36a7fda data-v-5a019cc9><div class="edit" data-v-5a019cc9><div class="edit-link" data-v-5a019cc9 data-v-3ae295f1><!----></div></div><div class="updated" data-v-5a019cc9><p class="last-updated" data-v-5a019cc9 data-v-52854a16><span class="prefix" data-v-52854a16>更新时间:</span><span class="datetime" data-v-52854a16></span></p></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"ad51a6e8\",\"go_index.md\":\"8b384a71\",\"interview_index.md\":\"c25552d8\",\"project_index.md\":\"ba12663e\",\"database_mongodb_index.md\":\"2fc73bf6\",\"database_mysql_index.md\":\"713c858d\",\"database_redis_index.md\":\"a8c16e57\",\"front-end_babel_index.md\":\"d0dc47c8\",\"front-end_js_base.md\":\"aca940fa\",\"front-end_js_index.md\":\"7933012b\",\"front-end_node_index.md\":\"f849c135\",\"front-end_react_index.md\":\"4d103b98\",\"front-end_vue_index.md\":\"f6211b4d\",\"front-end_webpack_index.md\":\"1fbcdfe4\",\"front-end_wechat_index.md\":\"7ec49044\"}")</script>
    <script type="module" async src="/assets/app.e8bd60e9.js"></script>
  </body>
</html>